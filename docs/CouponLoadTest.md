
## **서비스 부하 테스트 결과 및 장애 대응 문서**

### 1. **테스트 개요**
- **테스트 목적**: 선착순 쿠폰 발급 API의 성능 분석 및 개선 사항 도출
- **테스트 대상**: 선착순 쿠폰 발급 API
    - 쿠폰 발급 규칙: 최대 1200개, 선착순
- **테스트 시나리오**: 1000명의 유저가 동시에 쿠폰 발급 API에 요청을 보내는 상황

### 2. **테스트 결과 요약**

![coupon load test.png](img/coupon%20load%20test.png)
- **성능 결과**:
    - **쿠폰 발급 성공**: 945 / 1000 요청 성공 (94%)
    - **쿠폰 발급 실패**: 55 / 1000 요청 실패 (5.5%)
    - **API 응답 시간**:
        - 평균: 21.79초
        - 최소: 1.44초
        - 최대: 58.84초
        - p(90): 34.69초
        - p(95): 58.23초
    - **HTTP 요청 차단 시간** (http_req_blocked): 평균 974.51ms, 최대 1.81초
    - **HTTP 연결 시간** (http_req_connecting): 평균 876.52ms, 최대 1.58초
    - **응답 대기 시간** (http_req_waiting): 평균 21.79초, 최대 58.84초

### 3. **장애 발생 상황**
- **장애 증상**:
    - **쿠폰 발급 실패**: 1000명 중 55명의 요청이 실패 (5.5%)
    - **응답 시간 지연**: 평균 응답 시간이 21.79초로, 일부 요청은 최대 58.84초까지 지연됨
    - **API 차단**: HTTP 요청 차단 시간이 평균 974.51ms, 최대 1.81초로, 요청이 차단되는 시간이 길어짐
    - **연결 지연**: HTTP 연결 시간도 평균 876.52ms로, 연결에 시간이 많이 소요됨
    - **발급 실패 원인**: **타임아웃**에 의한 실패. 서버가 요청을 처리하는 시간 초과로 55건의 발급 요청이 실패함. 서버의 응답 지연이 주요 원인.

### 4. **장애 분석 및 성능 개선 영역**
- **장애 원인**:
    - **응답 시간 초과 (타임아웃)**: 평균 응답 시간이 21.79초로, 요청이 처리되는 데 시간이 많이 소요되었습니다. 특히, **응답 대기 시간**이 평균 21.79초에 달하며, 일부 요청은 58초까지 지연되었습니다.
    - **차단 시간 증가**: HTTP 요청 차단 시간(평균 974.51ms)은 요청을 처리하는 데 시간이 소요되는 문제가 있음을 시사합니다. 이는 **동시 요청**을 처리하는 과정에서 발생한 병목 현상으로, 타임아웃으로 이어졌습니다.
    - **쿠폰 발급 실패**: 1000명 중 55명이 쿠폰 발급에 실패한 이유는 **서버의 타임아웃**이 원인으로, 쿠폰 한도 부족 문제가 아니라 요청 처리 지연으로 인해 실패가 발생했습니다.

### 6. **장애 대응 및 성능 개선 방안**
- **응답 시간 최적화**:
    1. **비동기 처리 도입**:
        - 쿠폰 발급 요청을 비동기적으로 처리하여 여러 요청을 병렬로 처리하도록 개선합니다. 이를 통해 대기 시간을 줄이고 응답 속도를 개선할 수 있습니다.

    2. **큐 시스템 도입**:
        - 큐 시스템을 도입하여 요청을 순차적으로 처리하고, 한 번에 처리할 수 있는 쿠폰 수를 초과하는 요청은 대기시키는 방식으로 시스템을 개선합니다.

    3. **로드 밸런싱**:
        - **로드 밸런서**를 사용하여 서버 간 트래픽을 분산시키고, 특정 서버에 부하가 몰리지 않도록 분산 처리합니다. 이를 통해 서버의 부하를 분산하고, 응답 시간과 실패율을 감소시킬 수 있습니다.

    4. **데이터베이스 최적화**:
        - 선착순 쿠폰 발급 시 **DB 쿼리 최적화**를 통해 성능을 개선할 수 있습니다. 예를 들어, 쿠폰 발급 현황을 캐싱하여 DB 접근을 줄이고, 응답 시간을 단축시킬 수 있습니다.

    5. **API 응답 시간 모니터링**:
        - 지속적인 **모니터링 시스템**을 도입하여, 응답 시간이 길어지는 구간이나 성능 저하가 발생하는 지점을 빠르게 감지하고 대응할 수 있도록 개선합니다.

    6. **타임아웃 처리 개선**:
        - 요청이 많은 상황에서 **타임아웃**을 피할 수 있도록, **응답 시간**을 줄이는 방법을 우선적으로 고려합니다. 또한, **타임아웃을 발생시키지 않도록** 각 요청에 대한 처리 시간을 모니터링하고, 요청이 과도하게 지연되지 않도록 추가적인 리소스를 확보하는 방안을 고려합니다.

### 7. **향후 대응 계획**
- **단기 대응**:
    - **큐 시스템**과 **비동기 처리**를 적용하여 응답 시간과 실패율을 줄이고, 대기 시간을 최소화
    - **로드 밸런서**를 통한 트래픽 분산 및 **DB 최적화** 진행
    - 시스템 모니터링 도구를 설치하여 성능 저하 발생 시 즉각적인 알림을 받을 수 있도록 설정

- **중장기 대응**:
    - **API 성능 개선**을 위한 코드 리팩토링 및 트래픽 급증에 대비한 **고가용성 아키텍처** 설계
    - **쿠폰 발급 로직**에 대한 병목 구간을 파악하고, 트랜잭션 및 락 최적화를 통해 동시성 문제 해결

### 8. **결론**
- 본 테스트 결과에 따르면, **선착순 쿠폰 발급 API**에서 응답 지연과 일부 요청 실패가 발생했으며, 이는 **타임아웃** 문제로 인해 발생한 것입니다. 주요 원인은 **응답 대기 시간**과 **차단 시간**이 길어졌기 때문입니다.
- 제시된 개선 방안을 통해 성능을 최적화하고, 대규모 트래픽에도 안정적인 서비스를 제공할 수 있도록 개선할 것입니다.
